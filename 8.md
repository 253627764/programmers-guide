# Chapter 8: Event Dispatcher

## What is the EventDispatch mechanism?
`EventDispatch` is a mechanism for responding to user events.

The basics:

* Event listeners encapsulate your event processing code.
* Event dispatcher notifies listeners of user events.
* Event objects contain information about the event.

## 5 types of event listeners.
         
`EventListenerTouch` - responds to touch events
             
`EventListenerKeyboard` - responds to keyboard events
         
`EventListenerAcceleration` - responds to accelerometer events    
        
`EventListenMouse` - responds to mouse events
         
`EventListenerCustom` - responds to custom events   

## Creating a touch event
Touch events are the most important event in mobile gaming. They are easy to create 
and provide versatile functionality.
```cpp
//  Create a "one by one" touch event listener 
// (processes one touch at a time)
auto listener1 = EventListenerTouchOneByOne::create();
    
// When "swallow touches" is true, then returning 'true' from the
// onTouchBegan method will "swallow" the touch event, preventing 
// other listeners from using it.
listener1->setSwallowTouches(true);

// use a lambda!
listener1->onTouchBegan = [](Touch* touch, Event* event){
        // event->getCurrentTarget() returns the *listener's* 
        // sceneGraphPriority node.
        auto target = static_cast<Sprite*>(event->getCurrentTarget());

        //Get the position of the current point relative to the button
        Point locationInNode = target->convertToNodeSpace(touch->getLocation());
        Size s = target->getContentSize();
        Rect rect = Rect(0, 0, s.width, s.height);

        //Check the click area
        if (rect.containsPoint(locationInNode))
        {
            log("sprite began... x = %f, y = %f", locationInNode.x, locationInNode.y);
        
            return true;
        }
        return false;
    };

    // Trigger when moving touch
    listener1->onTouchMoved = [](Touch* touch, Event* event){
        auto target = static_cast<Sprite*>(event->getCurrentTarget());
        
        // Note: touch->getDelta(); will provide change in movement.
    };

    // Process the touch end event
    listener1->onTouchEnded = [=](Touch* touch, Event* event){
        auto target = static_cast<Sprite*>(event->getCurrentTarget());
        log("sprite onTouchesEnded.. ");
    };
```

## Registering event with the dispatcher
It is easy to register an event with the *Event Dispatcher*. Taking the sample touch event listener from above: 
```cpp
// Add listener
_eventDispatcher->addEventListenerWithSceneGraphPriority(listener1, 
sprite1);
```
It is important to note that a touch event can only be reigstered once per object. If you need to use the same listener for multiple objects you should
use `clone()`.
```cpp
// Add listener
_eventDispatcher->addEventListenerWithSceneGraphPriority(listener1, 
sprite1);

// Add the same listener to multiple objects.
_eventDispatcher->addEventListenerWithSceneGraphPriority(listener1->clone(),
 sprite2);

_eventDispatcher->addEventListenerWithSceneGraphPriority(listener1->clone(),
 sprite3);
```

## FixedPriority vs SceneGraphPriority
The *EventDispatcher* uses priorities to decide which listeners get delivered an event first.

`FixedPriority` is an integer value. Event listeners with lower Priority values get to process events before event listeners with higher Priority values.

`SceneGraphPriority` is a pointer to a `Node`. Event listeners whose *Nodes* have higher Z order values (that is, are drawn on top) receive events before event listeners whose *Nodes* have lower Z order values (that is, are drawn below). This ensures that touch events, for example, get delivered front-to-back, as you would expect.

## Removing events from the dispatcher
An added listener can be removed with following method:
```cpp
_eventDispatcher->removeEventListener(listener);
```
To remove all the listeners of the *event dispatcher*:

```cpp
_eventDispatcher->removeAllEventListeners();
```

When using `removeAllEventListeners()`, all the listeners for this node will be removed. 
Removing a specific listener is the recommended way. After using `removeAllEventListeners()` even 
`Menu` objects can not respond, because the events that are triggered are also removed.

